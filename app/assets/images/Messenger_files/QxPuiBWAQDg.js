if (self.CavalryLogger) { CavalryLogger.start_js(["doaxg"]); }

__d("MessageEventStream",["invariant","Int64","MercurySingletonProvider","MqttChannel","MqttLogger"],(function(a,b,c,d,e,f,g){"use strict";__p&&__p();h.getForFBID=function(a){return i.getForFBID(a)};h.setup=function(a){var b=a.fbid,c=a.msgSequenceId,d=a.fbidThreadFilter;a=a.queuePosition;!b&&g(0);b=h.getForFBID(b);b.init(c,d,a)};function h(a){this.$2="Disconnected",this.$1=a,this.$3=[],this.$6=b("MqttLogger").getInstance()}h.prototype.init=function(a,c,d){__p&&__p();if(!a&&!d)return this;this.$4=a?b("Int64").fromString(a.toString()):null;this.$7=c;this.$8=d;b("MqttChannel").subscribe("/t_ms",function(a){return this.$9(a)}.bind(this));b("MqttChannel").subscribe("/thread_typing",function(a){this.$10(a)}.bind(this));b("MqttChannel").subscribe("/orca_typing_notifications",function(a){this.$10(a)}.bind(this));b("MqttChannel").subscribe("/notify_disconnect",function(a){return this.$11(a)}.bind(this));this.$12(c,d);return this};h.prototype.$13=function(a){var b=null;try{var c="";for(var d=0;d<a.length;d++)c+=escape(String.fromCharCode(a[d]));b=JSON.parse(decodeURIComponent(c))}catch(a){this.$6.logError(a,"Unable to process data")}return b};h.prototype.$10=function(a){var b=this.$13(a);if(b==null){this.$6.logWarn("_processTypingData","Unable to process typing data");return}this.$3.forEach(function(a){typeof a.onTypingReceived==="function"&&a.onTypingReceived(b)})};h.prototype.addDeltaStreamListener=function(a){this.$3.push(a)};h.prototype.$11=function(a){var b="notify_disconnect";try{b=String.fromCharCode.apply(null,a)}catch(a){this.$6.logError(a,"Unknown disconnect reason")}this.$6.logWarn("_handleNotifyDisconnect","Disconnecting reason: "+b);b==="IRIS_CURSOR_LIMIT"&&(this.$5=null);this.$6.bumpCounter(b+"_request");this.$3.forEach(function(a){return a.onStreamDisconnect(b)})};h.prototype.$9=function(a){__p&&__p();a=this.$13(a);if(a==null){this.$6.logWarn("_processDeltas","Unable to process delta");return}var c=this.$1,d=this.$4;if(a.syncToken){this.$14(a);return}else if(a.queueEntityId!=c){this.$6.bumpCounter("delta_for_other_fbid");return}else{c=a.deltas;if(c&&d){var e=a.firstDeltaSeqId.toString();a=a.lastIssuedSeqId.toString();e=b("Int64").fromString(e);a=b("Int64").fromString(a);e.equals(d.add(b("Int64").ONE))?this.$15(e,a,c):e.compare(d)<0?(this.$6.bumpCounter("delta_batch_in_middle"),a.compare(d)>0&&this.$15(d.add(b("Int64").ONE),a,c)):(this.$6.bumpCounter("missing_deltas_get_diffs"),this.$16())}else this.$6.bumpCounter("process_deltas_invalid_state")}};h.prototype.$14=function(a){this.$5||(this.$5=a.syncToken),this.$4||(this.$4=b("Int64").fromString(a.firstDeltaSeqId.toString())),b("MqttChannel").subscribeChannelEvents({onMQTTStateChanged:function(a){this.$2!=="Connected"&&a==="Connected"&&(this.$5?this.$16():this.$12(this.$7,this.$8)),this.$2=a}.bind(this)}),this.$2="Connected"};h.prototype.$15=function(a,c,d){__p&&__p();a=a;for(var e=0;e<d.length;e++){var f=d[e],g=f["class"]||"Missing",h={seqId:a.toString(),type:g,status:""},i=1;if(g!="Missing")try{i=this.$17(f,g,a,h)}catch(a){h.status="err:"+a.message}else h.status="no type",this.$6.bumpCounter("missing_delta_type");a=a.add(b("Int64").fromInt(i))}this.$4=c};h.prototype.$17=function(a,c,d,e){__p&&__p();var f=1,g="";c==="NoOp"&&(f=a.numNoOps||f,g+="n:"+f);a.irisSeqId||(a.irisSeqId=d.toString(),g+="missing seq id");var h=b("Int64").fromString(a.irisSeqId.toString())||d;h.equals(d)?g+=" seqId match":(g+=" seqId mismatch",this.$6.bumpCounter("seq_id_running_id_mismatch"));var i={type:c,payload:a};this.$3.forEach(function(a){return a.onDeltaReceived(i)});e.status=g;return f};h.prototype.$12=function(a,c){var d;a&&(d={thread_filter:[{other_user_fbid:a}]});a={sync_api_version:10,max_deltas_able_to_process:1e3,delta_batch_size:500,encoding:"JSON",entity_fbid:this.$1,initial_titan_sequence_id:this.$4&&this.$4.toString(),deviceParams:d,queue_position:c};b("MqttChannel").publish("/messenger_sync_create_queue",JSON.stringify(a))};h.prototype.$16=function(){__p&&__p();if(!this.$4){this.$6.bumpCounter("get_diffs_no_seq_id");return}if(!this.$5){this.$6.bumpCounter("get_diffs_no_sync_token");return}var a={sync_token:this.$5,sync_api_version:10,max_deltas_able_to_process:1e3,delta_batch_size:500,encoding:"JSON",entity_fbid:this.$1,last_seq_id:this.$4.toString()};b("MqttChannel").publish("/messenger_sync_get_diffs",JSON.stringify(a))};var i=new(b("MercurySingletonProvider"))(h);e.exports=h}),null);